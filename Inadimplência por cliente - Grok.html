<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Títulos em Aberto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: #333; 
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: hidden;
        }
        .header { 
            text-align: center; 
            padding: 40px 20px; 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
            color: white; 
            margin: 0;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin: 0 0 10px 0; 
            font-weight: 300;
        }
        .header p { 
            font-size: 1.2em; 
            margin: 0; 
            opacity: 0.9;
        }
        .import-section { 
            padding: 30px; 
            background: white; 
            border-bottom: 1px solid #eee; 
        }
        .import-section h3 { 
            color: #34495e; 
            margin-top: 0;
        }
        .file-input { 
            margin-bottom: 15px; 
        }
        .file-input label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #555;
        }
        #fileInput { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            font-size: 16px;
        }
        #fileInput:focus { 
            border-color: #3498db; 
        }
        .search-container { 
            position: relative; 
            padding: 0 30px 30px 30px; 
            background: #f8f9fa;
        }
        #searchInput { 
            width: 100%; 
            padding: 18px 20px; 
            font-size: 16px; 
            border: 2px solid #3498db; 
            border-radius: 30px; 
            outline: none; 
            box-sizing: border-box; 
            box-shadow: 0 4px 10px rgba(52,152,219,0.1);
        }
        #searchInput:focus { 
            border-color: #2980b9; 
            box-shadow: 0 4px 15px rgba(52,152,219,0.2);
        }
        .autocomplete-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-top: none; 
            border-radius: 0 0 15px 15px; 
            max-height: 250px; 
            overflow-y: auto; 
            z-index: 1000; 
            display: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .autocomplete-item { 
            padding: 15px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid #f0f0f0; 
            transition: background 0.2s;
        }
        .autocomplete-item:hover { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        .autocomplete-item:last-child { 
            border-bottom: none; 
        }
        .search-buttons { 
            margin-top: 15px; 
            text-align: center;
        }
        button { 
            padding: 12px 25px; 
            margin: 5px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.3s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(52,152,219,0.3);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); 
            color: white; 
        }
        .btn-secondary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(149,165,166,0.3);
        }
        .btn-xlsx { 
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); 
            color: white; 
        }
        .btn-xlsx:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }
        .filters { 
            padding: 20px 30px; 
            background: white; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            flex-wrap: wrap;
        }
        .filters label { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            font-weight: 400; 
            color: #555;
        }
        .filters input[type="checkbox"] { 
            width: 18px; 
            height: 18px;
        }
        .results-section { 
            padding: 30px;
        }
        .results-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            text-align: center;
        }
        .results-header h3 { 
            margin: 0; 
            font-size: 1.5em;
        }
        .summary { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
            color: white; 
            padding: 25px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        .summary h3 { 
            margin: 0 0 15px 0; 
            font-size: 1.3em;
        }
        .summary p { 
            margin: 5px 0; 
            font-size: 1.1em;
        }
        .client-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); 
            gap: 25px; 
            margin-bottom: 30px;
        }
        .client-card { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            overflow: hidden; 
            transition: all 0.3s; 
        }
        .client-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }
        .client-header { 
            padding: 20px; 
            color: white; 
            font-weight: 500; 
            font-size: 1.2em;
        }
        .client-titles { 
            padding: 0 20px 20px 20px; 
        }
        .client-totals { 
            padding: 0 20px 20px 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        .total-card { 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            font-weight: 600;
        }
        .total-overdue { background: #ffebee; color: #c62828; }
        .total-future { background: #e8f5e9; color: #2e7d32; }
        .total-paid { background: #f5f5f5; color: #616161; }
        .total-general { background: #eceff1; color: #424242; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 15px;
        }
        th, td { 
            padding: 12px 8px; 
            text-align: left; 
            border-bottom: 1px solid #f0f0f0;
        }
        th { 
            background: #f8f9fa; 
            font-weight: 500; 
            color: #555;
        }
        .paid-title { 
            background-color: #f8f9fa; 
            color: #6c757d; 
        }
        .no-results { 
            text-align: center; 
            color: #7f8c8d; 
            padding: 60px 20px; 
            background: #f8f9fa; 
            border-radius: 15px; 
            font-size: 1.1em;
        }
        .pdf-btn, .xlsx-btn { 
            display: inline-block; 
            margin: 0 10px 30px; 
            width: 220px; 
            font-size: 16px;
        }
        .pdf-btn { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            color: white; 
        }
        .pdf-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        .xlsx-btn { 
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); 
            color: white; 
        }
        .xlsx-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }
        .client-checkboxes { 
            padding: 20px 30px; 
            background: white; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
        }
        .client-checkboxes label { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            cursor: pointer; 
            font-weight: 400; 
            color: #555;
        }
        .client-checkboxes input[type="checkbox"] { 
            width: 16px; 
            height: 16px;
        }
        .pdf-preview { 
            display: none; 
            margin-top: 20px; 
            padding: 20px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .pdf-preview canvas { 
            max-width: 100%; 
            height: auto;
        }
        @media (max-width: 768px) { 
            .container { 
                margin: 10px; 
                border-radius: 10px;
            }
            .header { 
                padding: 30px 15px;
            }
            .header h1 { 
                font-size: 2em;
            }
            .filters, .client-checkboxes { 
                flex-direction: column; 
                gap: 15px; 
                align-items: center;
            }
            .client-cards { 
                grid-template-columns: 1fr; 
                gap: 15px;
            }
            .results-section, .search-container, .import-section { 
                padding: 20px;
            }
            .pdf-btn, .xlsx-btn { 
                display: block; 
                margin: 0 auto 15px; 
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Consulta de Títulos em Aberto</h1>
            <p>Importe sua planilha e consulte os títulos vencidos ou a vencer</p>
        </div>

        <div class="import-section">
            <h3>Importar Planilha</h3>
            <div class="file-input">
                <label for="fileInput">Selecionar Arquivo Excel</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="importFile()">
            </div>
            <p>Formato esperado: Colunas CLIENTE, VENCIMENTO, DESCRIÇÃO, VALOR</p>
            <p>Arquivo: <span id="fileName"></span></p>
            <p>Registros carregados: <span id="recordsLoaded">0</span></p>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Digite o nome do cliente para busca automática..." onkeyup="handleSearchInput()">
            <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
            <div class="search-buttons">
                <button class="btn-primary" onclick="performSearch()">Pesquisar</button>
                <button class="btn-secondary" onclick="clearSearch()">Limpar</button>
            </div>
        </div>

        <div class="client-checkboxes" id="clientCheckboxes" style="display: none;">
            <h3>Selecione os Clientes:</h3>
        </div>

        <div class="filters">
            <label><input type="checkbox" id="onlyOverdue" checked onchange="updateResults()"> Mostrar apenas títulos vencidos ou a vencer hoje</label>
            <label><input type="checkbox" id="showFuture" onchange="updateResults()"> Mostrar títulos que ainda não venceram</label>
            <label><input type="checkbox" id="showPaid" onchange="updateResults()"> Mostrar títulos quitados</label>
        </div>

        <div class="results-section">
            <div class="results-header">
                <h3>Clientes encontrados: <span id="clientsFound">0</span></h3>
            </div>

            <div class="summary" id="summary" style="display: none;">
                <h3>Resumo Financeiro</h3>
                <p>Total Vencidos: <span id="totalOverdue">R$ 0,00</span></p>
                <p>Total A Vencer: <span id="totalFuture">R$ 0,00</span></p>
                <p>Total Quitados: <span id="totalPaid">R$ 0,00</span></p>
                <p>Total Geral: <span id="totalGeneral">R$ 0,00</span></p>
                <p>Clientes encontrados: <span id="clientsCount">0</span></p>
            </div>

            <div id="results">
                <div class="no-results">Nenhum resultado encontrado<br>Tente pesquisar por outro nome ou alterar os filtros.</div>
            </div>
        </div>

        <button class="pdf-btn" onclick="previewPDF()">Visualizar PDF</button>
        <button class="xlsx-btn" onclick="generateXLSX()">Gerar XLSX</button>
        <div class="pdf-preview" id="pdfPreview"></div>
    </div>

    <script>
        let data = [];
        let clients = {};
        let allClientNames = [];
        let selectedClients = new Set();
        const currentDate = new Date('2025-09-17T16:47:00-03:00');
        const serialOffset = 25569;

        function parseBRL(value) {
            if (!value) return 0;
            value = String(value).replace(/[^0-9.,-]/g, '');
            if (value.includes(',') && value.includes('.')) {
                value = value.replace(/\./g, '').replace(',', '.');
            } else {
                value = value.replace(',', '.');
            }
            let num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        function serialToDate(serial) {
            if (!serial || isNaN(serial)) return null;
            return new Date((parseFloat(serial) - serialOffset) * 86400 * 1000);
        }

        function levenshteinDistance(str1, str2) {
            const matrix = Array(str2.length + 1).fill().map(() => Array(str1.length + 1).fill(0));
            for (let i = 0; i <= str2.length; i++) matrix[i][0] = i;
            for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= str2.length; i++)
                for (let j = 1; j <= str1.length; j++)
                    matrix[i][j] = str2[i-1] === str1[j-1] ? matrix[i-1][j-1] : Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
            return matrix[str2.length][str1.length];
        }

        function fuzzyMatch(query, str, threshold = 0.6) {
            if (str.toLowerCase().includes(query.toLowerCase())) return 1;
            const distance = levenshteinDistance(query.toLowerCase(), str.toLowerCase());
            const maxLen = Math.max(query.length, str.length);
            return 1 - (distance / maxLen) >= threshold ? 1 - (distance / maxLen) : 0;
        }

        function importFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processData();
            };
            reader.readAsBinaryString(file);
        }

        function processData() {
            clients = {};
            allClientNames = [];
            let loadedCount = 0;
            if (data.length === 0) return;

            // Assume first row is header
            const headers = data[0];
            const clientCol = headers.indexOf('CLIENTE');
            const vencCol = headers.indexOf('VENCIMENTO');
            const descCol = headers.indexOf('DESCRIÇÃO');
            const valorCol = headers.indexOf('VALOR');
            const liqCol = headers.indexOf('LIQUIDAÇÃO');

            if (clientCol === -1 || vencCol === -1 || descCol === -1 || valorCol === -1) {
                alert('As colunas CLIENTE, VENCIMENTO, DESCRIÇÃO e VALOR são obrigatórias.');
                return;
            }

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!Array.isArray(row) || row.length <= Math.max(clientCol, vencCol, descCol, valorCol)) continue;

                const clientName = String(row[clientCol]).trim();
                const vencimento = row[vencCol];
                const descricao = String(row[descCol]).trim();
                let valor = String(row[valorCol]).trim();
                const liquidacao = row[liqCol];

                // Clean and parse valor usando parseBRL
                valor = parseBRL(row[valorCol]);

                if (clientName && !isNaN(valor)) {
                    if (!clients[clientName]) {
                        clients[clientName] = { titles: [] };
                        allClientNames.push(clientName);
                    }
                    clients[clientName].titles.push({
                        venc: vencimento,
                        desc: descricao,
                        valor: valor,
                        liq: liquidacao
                    });
                    loadedCount++;
                }
            }

            allClientNames.sort();
            document.getElementById('recordsLoaded').textContent = loadedCount;
        }

        function calculateTotalByCategory(titles, onlyOverdue, showFuture, showPaid) {
            let overdue = 0, future = 0, paid = 0;
            titles.forEach(title => {
                const dueDate = serialToDate(title.venc);
                const liqDate = serialToDate(title.liq);
                if (!title.liq || !liqDate) {
                    if (dueDate <= currentDate) overdue += title.valor;
                    else future += title.valor;
                } else if (showPaid) paid += title.valor;
            });
            return { overdue, future, paid, general: overdue + future + paid };
        }

        function calculateGlobalTotals(filteredClients) {
            let globalTotals = { overdue: 0, future: 0, paid: 0, general: 0 };
            for (let client in filteredClients) {
                const totals = filteredClients[client].totals;
                globalTotals.overdue += totals.overdue;
                globalTotals.future += totals.future;
                globalTotals.paid += totals.paid;
                globalTotals.general += totals.general;
            }
            return globalTotals;
        }

        function isTitleOpen(title) {
            return !title.liq || !serialToDate(title.liq);
        }

        function handleSearchInput() {
            const query = document.getElementById('searchInput').value.trim();
            const dropdown = document.getElementById('autocompleteDropdown');
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            const matches = allClientNames
                .map(name => ({ name, score: fuzzyMatch(query, name) }))
                .filter(match => match.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 10);

            let html = '';
            matches.forEach(match => {
                html += `<div class="autocomplete-item" onclick="selectClient('${match.name.replace(/'/g, "\\'")}')">${match.name} (similaridade: ${(match.score * 100).toFixed(0)}%)</div>`;
            });

            dropdown.innerHTML = html;
            dropdown.style.display = matches.length > 0 ? 'block' : 'none';
        }

        function selectClient(clientName) {
            document.getElementById('searchInput').value = clientName;
            document.getElementById('autocompleteDropdown').style.display = 'none';
            showClientCheckboxes();
        }

        function showClientCheckboxes() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                document.getElementById('clientCheckboxes').style.display = 'none';
                return;
            }

            const matches = allClientNames
                .map(name => ({ name, score: fuzzyMatch(query, name) }))
                .filter(match => match.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 10);

            let html = '<h3>Selecione os Clientes:</h3>';
            matches.forEach(match => {
                html += `<label><input type="checkbox" name="client" value="${match.name}" onchange="updateResults()"> ${match.name}</label>`;
            });
            document.getElementById('clientCheckboxes').innerHTML = html;
            document.getElementById('clientCheckboxes').style.display = 'block';
        }

        function getSelectedClients() {
            selectedClients.clear();
            document.querySelectorAll('input[name="client"]:checked').forEach(cb => selectedClients.add(cb.value));
            return selectedClients;
        }

        function updateResults() {
            const onlyOverdue = document.getElementById('onlyOverdue').checked;
            const showFuture = document.getElementById('showFuture').checked;
            const showPaid = document.getElementById('showPaid').checked;
            const selected = getSelectedClients();

            let filteredClients = {};
            let clientCount = 0;

            for (let client of selected) {
                if (clients[client]) {
                    let clientTitles = clients[client].titles.slice();

                    clientTitles = clientTitles.filter(title => {
                        const dueDate = serialToDate(title.venc);
                        if (!dueDate) return false;
                        const isOverdueOrToday = dueDate <= currentDate;
                        const isFuture = dueDate > currentDate;

                        if (onlyOverdue && !showFuture) return isOverdueOrToday;
                        else if (showFuture && !onlyOverdue) return isFuture;
                        else return true;
                    });

                    let openTitles = clientTitles.filter(isTitleOpen);
                    let paidTitles = showPaid ? clientTitles.filter(title => !isTitleOpen(title)) : [];

                    let displayTitles = openTitles.concat(paidTitles);

                    if (displayTitles.length > 0) {
                        const totals = calculateTotalByCategory(displayTitles, onlyOverdue, showFuture, showPaid);
                        filteredClients[client] = { titles: displayTitles, totals };
                        clientCount++;
                    }
                }
            }

            const globalTotals = calculateGlobalTotals(filteredClients);
            document.getElementById('clientsFound').textContent = clientCount;
            document.getElementById('clientsCount').textContent = clientCount;
            document.getElementById('totalOverdue').textContent = globalTotals.overdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalFuture').textContent = globalTotals.future.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalPaid').textContent = globalTotals.paid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('totalGeneral').textContent = globalTotals.general.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summary').style.display = clientCount > 0 ? 'block' : 'none';

            displayResults(filteredClients);
        }

        function displayResults(filteredClients) {
            const resultsDiv = document.getElementById('results');
            if (Object.keys(filteredClients).length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">Nenhum resultado encontrado<br>Tente selecionar outros clientes ou alterar os filtros.</div>';
                return;
            }

            let html = '<div class="client-cards">';
            let colorIndex = 0;
            const gradients = [
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
            ];

            for (let client in filteredClients) {
                const gradient = gradients[colorIndex % gradients.length];
                html += `<div class="client-card">`;
                html += `<div class="client-header" style="background: ${gradient};">${client}</div>`;
                html += `<div class="client-titles">`;
                html += `<table>
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;

                filteredClients[client].titles
                    .sort((a, b) => serialToDate(a.venc) - serialToDate(b.venc))
                    .forEach(title => {
                        const dueStr = serialToDate(title.venc) ? serialToDate(title.venc).toLocaleDateString('pt-BR') : 'N/A';
                        const valorStr = title.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        const isOpen = isTitleOpen(title);
                        const status = isOpen ? 'Aberto' : 'Quitado';
                        const className = isOpen ? '' : 'paid-title';
                        html += `<tr class="${className}">
                            <td style="font-size: 0.9em;">${title.desc}</td>
                            <td>${dueStr}</td>
                            <td style="font-weight: 500; color: ${isOpen ? '#27ae60' : '#6c757d'};">${valorStr}</td>
                            <td>${status}</td>
                        </tr>`;
                    });

                html += `</tbody></table>
                </div>`;
                html += `<div class="client-totals">`;
                const totals = filteredClients[client].totals;
                html += `<div class="total-card total-overdue">Vencidos: ${totals.overdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
                html += `<div class="total-card total-future">A Vencer: ${totals.future.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
                if (document.getElementById('showPaid').checked) {
                    html += `<div class="total-card total-paid">Quitados: ${totals.paid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
                }
                html += `<div class="total-card total-general">Total Geral: ${totals.general.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
                html += `</div>`;
                html += `</div>`;
                colorIndex++;
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            document.getElementById('clientCheckboxes').style.display = 'none';
            document.getElementById('clientCheckboxes').innerHTML = '<h3>Selecione os Clientes:</h3>';
            selectedClients.clear();
            document.getElementById('onlyOverdue').checked = true;
            document.getElementById('showFuture').checked = false;
            document.getElementById('showPaid').checked = false;
            document.getElementById('clientsFound').textContent = '0';
            document.getElementById('clientsCount').textContent = '0';
            document.getElementById('totalOverdue').textContent = 'R$ 0,00';
            document.getElementById('totalFuture').textContent = 'R$ 0,00';
            document.getElementById('totalPaid').textContent = 'R$ 0,00';
            document.getElementById('totalGeneral').textContent = 'R$ 0,00';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('results').innerHTML = '<div class="no-results">Nenhum resultado encontrado<br>Tente pesquisar por outro nome ou alterar os filtros.</div>';
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('pdfPreview').innerHTML = '';
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                showClientCheckboxes();
            }
        }

        // FUNÇÃO MELHORADA PARA GERAÇÃO DO PDF
        function previewPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const query = document.getElementById('searchInput').value.trim();
            let yPos = 20;
            let globalTotals = { overdue: 0, future: 0, paid: 0, general: 0 };
            const onlyOverdue = document.getElementById('onlyOverdue').checked;
            const showFuture = document.getElementById('showFuture').checked;
            const showPaid = document.getElementById('showPaid').checked;
            const selected = getSelectedClients();
            const pageHeight = 297; // A4 height in mm
            const marginBottom = 20;

            // Cabeçalho do documento
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 30, 'F');
            doc.text('Relatório de Títulos em Aberto', 105, 20, { align: 'center' });
            yPos = 40;

            // Informações da consulta
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Data da Consulta: ${currentDate.toLocaleDateString('pt-BR')}`, 20, yPos);
            yPos += 6;
            if (query) {
                doc.text(`Busca: ${query}`, 20, yPos);
                yPos += 6;
            }
            yPos += 10;

            let clientIndex = 0;
            const colors = [
                [255, 236, 210], [252, 182, 159], [168, 237, 234], 
                [254, 214, 227], [210, 153, 194]
            ];

            for (let client of selected) {
                if (!clients[client]) continue;

                let clientTitles = clients[client].titles.filter(title => {
                    const dueDate = serialToDate(title.venc);
                    if (!dueDate) return false;
                    const isOverdueOrToday = dueDate <= currentDate;
                    const isFuture = dueDate > currentDate;

                    if (onlyOverdue && !showFuture) return isOverdueOrToday;
                    else if (showFuture && !onlyOverdue) return isFuture;
                    else return true;
                });

                let openTitles = clientTitles.filter(isTitleOpen);
                let paidTitles = showPaid ? clientTitles.filter(title => !isTitleOpen(title)) : [];
                let displayTitles = openTitles.concat(paidTitles);

                if (displayTitles.length === 0) continue;

                const totals = calculateTotalByCategory(displayTitles, onlyOverdue, showFuture, showPaid);
                globalTotals.overdue += totals.overdue;
                globalTotals.future += totals.future;
                globalTotals.paid += totals.paid;
                globalTotals.general += totals.general;

                // Verificar se precisa de nova página
                const estimatedHeight = 25 + (displayTitles.length * 8) + 35; // Header + títulos + totais
                if (yPos + estimatedHeight > pageHeight - marginBottom) {
                    doc.addPage();
                    yPos = 20;
                }

                // Cabeçalho do cliente
                const color = colors[clientIndex % colors.length];
                const maxClientNameLength = 50;
                const clientName = client.length > maxClientNameLength ? 
                    client.substring(0, maxClientNameLength) + '...' : client;
                
                doc.setFillColor(color[0], color[1], color[2]);
                doc.roundedRect(15, yPos, 180, 20, 3, 3, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(52, 73, 94);
                doc.text(clientName, 20, yPos + 13);
                yPos += 25;

                // Títulos do cliente em formato de tabela
                if (displayTitles.length > 0) {
                    // Cabeçalho da tabela
                    doc.setFillColor(245, 245, 245);
                    doc.rect(15, yPos, 180, 8, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Descrição', 20, yPos + 5);
                    doc.text('Vencimento', 110, yPos + 5);
                    doc.text('Valor', 140, yPos + 5);
                    doc.text('Status', 170, yPos + 5);
                    yPos += 8;

                    // Linhas da tabela
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    displayTitles.sort((a, b) => serialToDate(a.venc) - serialToDate(b.venc))
                        .forEach((title, index) => {
                            // Verificar se precisa de nova página
                            if (yPos + 8 > pageHeight - marginBottom) {
                                doc.addPage();
                                yPos = 20;
                                
                                // Repetir cabeçalho da tabela na nova página
                                doc.setFillColor(245, 245, 245);
                                doc.rect(15, yPos, 180, 8, 'F');
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(9);
                                doc.text('Descrição', 20, yPos + 5);
                                doc.text('Vencimento', 110, yPos + 5);
                                doc.text('Valor', 140, yPos + 5);
                                doc.text('Status', 170, yPos + 5);
                                yPos += 8;
                                doc.setFont('helvetica', 'normal');
                                doc.setFontSize(8);
                            }

                            const dueStr = serialToDate(title.venc) ? 
                                serialToDate(title.venc).toLocaleDateString('pt-BR') : 'N/A';
                            const valorStr = title.valor.toLocaleString('pt-BR', { 
                                style: 'currency', currency: 'BRL' 
                            });
                            const status = isTitleOpen(title) ? 'Aberto' : 'Quitado';
                            const isOpen = isTitleOpen(title);

                            // Alternar cor de fundo das linhas
                            if (index % 2 === 0) {
                                doc.setFillColor(250, 250, 250);
                                doc.rect(15, yPos, 180, 7, 'F');
                            }

                            doc.setTextColor(isOpen ? 0 : 128);
                            
                            // Truncar descrição se muito longa
                            const maxDescLength = 40;
                            const truncatedDesc = title.desc.length > maxDescLength ? 
                                title.desc.substring(0, maxDescLength) + '...' : title.desc;
                            
                            doc.text(truncatedDesc, 20, yPos + 5);
                            doc.text(dueStr, 110, yPos + 5);
                            doc.text(valorStr, 140, yPos + 5);
                            doc.text(status, 170, yPos + 5);
                            yPos += 7;
                        });

                    yPos += 5;
                }

                // Verificar se precisa de nova página para os totais
                if (yPos + 30 > pageHeight - marginBottom) {
                    doc.addPage();
                    yPos = 20;
                }

                // Totais do cliente
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(15, yPos, 180, 25, 3, 3, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                
                doc.text(`Totais - ${clientName}`, 20, yPos + 8);
                doc.setFontSize(9);
                doc.text(`Vencidos: ${totals.overdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 20, yPos + 15);
                doc.text(`A Vencer: ${totals.future.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 20, yPos + 20);
                
                if (showPaid) {
                    doc.text(`Quitados: ${totals.paid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 110, yPos + 15);
                }
                doc.text(`Total Geral: ${totals.general.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 110, yPos + 20);
                
                yPos += 35;
                clientIndex++;
            }

            // Totais gerais do relatório
            if (globalTotals.general > 0) {
                // Verificar se precisa de nova página
                if (yPos + 35 > pageHeight - marginBottom) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFillColor(52, 152, 219);
                doc.roundedRect(15, yPos, 180, 30, 3, 3, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.text('RESUMO GERAL DO RELATÓRIO', 105, yPos + 10, { align: 'center' });
                
                doc.setFontSize(11);
                doc.text(`Total Vencidos: ${globalTotals.overdue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 20, yPos + 18);
                doc.text(`Total A Vencer: ${globalTotals.future.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 20, yPos + 24);
                
                if (showPaid) {
                    doc.text(`Total Quitados: ${globalTotals.paid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 110, yPos + 18);
                }
                doc.text(`TOTAL GERAL: ${globalTotals.general.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 110, yPos + 24);
            }

            const pdfDataUri = doc.output('datauristring');
            const pdfPreview = document.getElementById('pdfPreview');
            pdfPreview.style.display = 'block';
            pdfPreview.innerHTML = `<iframe src="${pdfDataUri}" width="100%" height="600px" style="border: none;"></iframe>
                                   <button class="btn-primary" style="margin-top: 10px;" onclick="downloadPDF('${pdfDataUri}')">Baixar PDF</button>`;
        }

        function downloadPDF(pdfDataUri) {
            const link = document.createElement('a');
            link.href = pdfDataUri;
            link.download = `relatorio_titulos_aberto_${currentDate.toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('pdfPreview').innerHTML = '';
        }

        function generateXLSX() {
            const wb = XLSX.utils.book_new();
            const selected = getSelectedClients();
            const onlyOverdue = document.getElementById('onlyOverdue').checked;
            const showFuture = document.getElementById('showFuture').checked;
            const showPaid = document.getElementById('showPaid').checked;
            let allData = [];

            allData.push(['Cliente', 'Descrição', 'Vencimento', 'Valor', 'Status']);

            for (let client of selected) {
                if (!clients[client]) continue;

                let clientTitles = clients[client].titles.filter(title => {
                    const dueDate = serialToDate(title.venc);
                    if (!dueDate) return false;
                    const isOverdueOrToday = dueDate <= currentDate;
                    const isFuture = dueDate > currentDate;

                    if (onlyOverdue && !showFuture) return isOverdueOrToday;
                    else if (showFuture && !onlyOverdue) return isFuture;
                    else return true;
                });

                let openTitles = clientTitles.filter(isTitleOpen);
                let paidTitles = showPaid ? clientTitles.filter(title => !isTitleOpen(title)) : [];
                let displayTitles = openTitles.concat(paidTitles);

                displayTitles.forEach(title => {
                    const dueStr = serialToDate(title.venc) ? serialToDate(title.venc).toLocaleDateString('pt-BR') : 'N/A';
                    const valorStr = title.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const status = isTitleOpen(title) ? 'Aberto' : 'Quitado';
                    allData.push([client, title.desc, dueStr, valorStr, status]);
                });
            }

            const ws = XLSX.utils.aoa_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, ws, 'Títulos em Aberto');
            XLSX.writeFile(wb, `relatorio_titulos_aberto_${currentDate.toISOString().split('T')[0]}.xlsx`);
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const input = document.getElementById('searchInput');
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        clearSearch();
    </script>
</body>
</html>

